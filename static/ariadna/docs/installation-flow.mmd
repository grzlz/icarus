graph TD
    Start([ğŸ‘¤ Usuario ejecuta install.sh]) --> CheckRoot{Â¿Ejecutando<br/>con sudo?}

    CheckRoot -->|SÃ­| ErrorRoot[âŒ Error: No ejecutar con sudo<br/>Mostrar razÃ³n y soluciÃ³n]
    ErrorRoot --> Exit1[ğŸ›‘ Salir]

    CheckRoot -->|No| CheckNvim{Â¿Neovim<br/>instalado?}

    CheckNvim -->|No| DetectOS{Detectar<br/>Sistema Operativo}

    DetectOS -->|macOS| CheckBrew{Â¿Homebrew<br/>disponible?}
    CheckBrew -->|SÃ­| InstallMac[brew install neovim]
    CheckBrew -->|No| ErrorBrew[âŒ Instalar Homebrew primero]
    ErrorBrew --> Exit2[ğŸ›‘ Salir]

    DetectOS -->|Linux| DetectPM{Detectar<br/>Package Manager}
    DetectPM -->|apt| InstallApt[sudo apt-get install neovim]
    DetectPM -->|dnf| InstallDnf[sudo dnf install neovim]
    DetectPM -->|pacman| InstallPacman[sudo pacman -S neovim]
    DetectPM -->|zypper| InstallZypper[sudo zypper install neovim]
    DetectPM -->|Ninguno| ErrorPM[âŒ Package manager no soportado]
    ErrorPM --> Exit3[ğŸ›‘ Salir]

    DetectOS -->|Windows| CheckWinPM{Â¿winget o<br/>chocolatey?}
    CheckWinPM -->|winget| InstallWinget[winget install Neovim]
    CheckWinPM -->|choco| InstallChoco[choco install neovim]
    CheckWinPM -->|Ninguno| ErrorWin[âŒ Instalar winget/choco]
    ErrorWin --> Exit4[ğŸ›‘ Salir]

    DetectOS -->|Otro OS| ErrorOS[âŒ OS no soportado]
    ErrorOS --> Exit5[ğŸ›‘ Salir]

    InstallMac --> VerifyNvim[âœ… Neovim instalado]
    InstallApt --> VerifyNvim
    InstallDnf --> VerifyNvim
    InstallPacman --> VerifyNvim
    InstallZypper --> VerifyNvim
    InstallWinget --> VerifyNvim
    InstallChoco --> VerifyNvim

    CheckNvim -->|SÃ­| VerifyNvim

    VerifyNvim --> ShowVersion[ğŸ“¦ Mostrar versiÃ³n de Neovim]
    ShowVersion --> CheckNode{Â¿Node.js<br/>instalado?}

    CheckNode -->|SÃ­| ShowNode[ğŸ“¦ Mostrar versiÃ³n de Node.js]
    CheckNode -->|No| WarnNode[âš ï¸ Advertencia: Node.js necesario para LSP]

    ShowNode --> CheckGit
    WarnNode --> CheckGit

    CheckGit{Â¿Git<br/>instalado?} -->|No| ErrorGit[âŒ Git es requerido]
    ErrorGit --> Exit6[ğŸ›‘ Salir]

    CheckGit -->|SÃ­| ShowGit[âœ… Git encontrado]
    ShowGit --> VerifyPerms[ğŸ” Verificar permisos de directorios]

    VerifyPerms --> CheckOwnership{Â¿Directorios<br/>owned por<br/>usuario actual?}

    CheckOwnership -->|No| ErrorOwnership[âŒ Directorios owned por root<br/>Probablemente ejecutaste con sudo antes]
    ErrorOwnership --> ShowFixOwnership[ğŸ’¡ Mostrar comando para limpiar:<br/>sudo rm -rf ~/.config/nvim ...]
    ShowFixOwnership --> Exit7[ğŸ›‘ Salir]

    CheckOwnership -->|SÃ­| CheckWritable{Â¿~/.cache<br/>es escribible?}

    CheckWritable -->|No| ErrorWritable[âŒ Sin permisos de escritura en cache]
    ErrorWritable --> ShowFixWritable[ğŸ’¡ Mostrar comando:<br/>sudo chown -R $USER ~/.cache]
    ShowFixWritable --> Exit8[ğŸ›‘ Salir]

    CheckWritable -->|SÃ­| PermsOK[âœ… Permisos verificados]

    PermsOK --> CheckExisting{Â¿ConfiguraciÃ³n<br/>existente?}

    CheckExisting -->|SÃ­ - nvim config| BackupConfig[ğŸ“¦ Crear backup:<br/>~/.config/nvim.backup.TIMESTAMP]
    CheckExisting -->|SÃ­ - nvim data| BackupData[ğŸ“¦ Backup de datos:<br/>~/.local/share/nvim.backup.TIMESTAMP]
    CheckExisting -->|SÃ­ - nvim cache| BackupCache[ğŸ“¦ Backup de cache:<br/>~/.cache/nvim.backup.TIMESTAMP]
    CheckExisting -->|SÃ­ - nvim state| BackupState[ğŸ“¦ Backup de state:<br/>~/.local/state/nvim.backup.TIMESTAMP]

    BackupConfig --> CreateDirs
    BackupData --> CreateDirs
    BackupCache --> CreateDirs
    BackupState --> CreateDirs
    CheckExisting -->|No| CreateDirs

    CreateDirs[ğŸ“‚ Crear estructura de directorios] --> CreateConfig[mkdir -p ~/.config/nvim/lua/config]
    CreateConfig --> CreatePlugins[mkdir -p ~/.config/nvim/lua/plugins]
    CreatePlugins --> CreateCache[mkdir -p ~/.cache/nvim]
    CreateCache --> CreateShare[mkdir -p ~/.local/share/nvim]
    CreateShare --> CreateState[mkdir -p ~/.local/state/nvim]

    CreateState --> DirsOK[âœ… Directorios creados]

    DirsOK --> PrepareDownload[ğŸŒ Preparar descarga desde icarus.mx/ariadna]

    PrepareDownload --> DownloadFiles[ğŸ“¥ Descargar archivos de configuraciÃ³n]

    DownloadFiles --> Loop{Por cada<br/>archivo}

    Loop --> ShowProgress[ğŸ›ï¸ Mostrar mensaje aleatorio:<br/>'Desenredando el laberinto...'<br/>'Esquivando al Minotauro...'<br/>'Siguiendo el hilo dorado...']

    ShowProgress --> ProgressBar[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ XX% - archivo.lua]

    ProgressBar --> Download[curl -fsSL icarus.mx/ariadna/FILE]

    Download -->|Error| ErrorDownload[âŒ Error descargando archivo]
    ErrorDownload --> Exit9[ğŸ›‘ Salir]

    Download -->|OK| NextFile{Â¿MÃ¡s<br/>archivos?}

    NextFile -->|SÃ­| Loop
    NextFile -->|No| DownloadsComplete[âœ… Hilo seguido - Â¡Escapaste del laberinto!]

    DownloadsComplete --> InstallPlugins[ğŸ¨ Instalar plugins y LSP servers]

    InstallPlugins --> RunNvim[nvim --headless '+Lazy! sync' '+qa']

    RunNvim --> WaitPlugins[â³ Esperar instalaciÃ³n ~2-3 minutos]

    WaitPlugins --> PluginsOK[âœ… Plugins instalados]

    PluginsOK --> ShowSuccess[ğŸ‰ Â¡InstalaciÃ³n completada!]

    ShowSuccess --> NextSteps[ğŸ“š Mostrar prÃ³ximos pasos:<br/>1. nvim<br/>2. Esperar Mason LSP (~1 min)<br/>3. Reiniciar<br/>4. :help ariadna]

    NextSteps --> ShowKeybindings[âŒ¨ï¸ Mostrar keybindings esenciales:<br/>Space Space - Buscar archivos<br/>Space e - Explorador<br/>Space h - Ayuda]

    ShowKeybindings --> ShowBranding[ğŸ›ï¸ Hecho con <3 por icarus.mx]

    ShowBranding --> Complete([âœ¨ Usuario listo para usar Neovim])

    style Start fill:#7dcfff,stroke:#1f2335,stroke-width:3px
    style Complete fill:#9ece6a,stroke:#1f2335,stroke-width:3px
    style ErrorRoot fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorBrew fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorPM fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorWin fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorOS fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorGit fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorOwnership fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorWritable fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style ErrorDownload fill:#f7768e,stroke:#1f2335,stroke-width:2px
    style VerifyNvim fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style ShowGit fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style PermsOK fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style DirsOK fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style DownloadsComplete fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style PluginsOK fill:#9ece6a,stroke:#1f2335,stroke-width:2px
    style ShowProgress fill:#ff9e64,stroke:#1f2335,stroke-width:2px
    style ProgressBar fill:#e0af68,stroke:#1f2335,stroke-width:2px
    style ShowSuccess fill:#bb9af7,stroke:#1f2335,stroke-width:2px
